extends index

block title
	title= toonName + ' | Online Dresden Files RPG Character Hosting | ToonStore.net'

block append styles
	link(rel='stylesheet', type='text/css', href='//fonts.googleapis.com/css?family=Metamorphous')
	link(rel='stylesheet', type='text/css', href='/static/css/charsheet.css')
	link(rel='stylesheet', type='text/css', href='/static/css/jquery-ui-1.10.3.custom.css')

block append includes
	script(src='/static/js/jquery-ui-1.10.3.custom.js')
	script(src='/static/js/jquery.ui.touch-punch.min.js')
	script(src='https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js')
	script(src='https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-resource.js')
	//script(src='/static/js/angular-dragdrop/src/angular-dragdrop.min.js')
	script(src='/static/js/char-extras.js')
	script(src='/static/js/char-controllers.js')
	script(src='/static/js/markdown.js')
	script.
		overrideUserRedirect = true;
		$(document).ready(function(){
			$('.navbar > ul.navmenu').menu({position: {collision: 'flipfit'}});
		});

block append header

	if logged_user == owner
		#charnav.navbar(ng-controller='GeneralCtrl')
			ul.navmenu
				li
					a Panels
						span.subarrow
					ul
						li
							a Optional Panels
								span.subarrow
							ul
								li
									input(type='checkbox')
									a(href='#notes') Notes
								li
									input(type='checkbox', ng-model='data.skills.is_shifter')
									a(href='#skills') Shapeshifter
								//li
									input(type='checkbox')
									a(href='#invent') Inventory
								//li
									input(type='checkbox')
									a(href='#rotes') Spellcaster/Rotes
								//li
									input(type='checkbox')
									a(href='#spellcalc') Spellcaster/Calculator
						li: a(href='#aspects') Aspects
						li: a(href='#skills') Skills
						li: a(href='#stress') Stress
						li: a(href='#conseq') Consequences
						li: a(href='#totals') Totals
						li: a(href='#powers') Stunts & Powers

			.navitem: a(href='javascript:;', ng-click='data.$save()') Save

block content

	.sheet-panel-group

		#general.sheet-panel(ng-controller="GeneralCtrl")
			p.sectionHeader
				span(ng-hide='editing') {{data.name}}
				input(type='text', ng-show='editing', ng-model="data.name")
				if logged_user == owner
					input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_150_edit.png', ng-click='editing = !editing')
			div
				span(ng-hide='editing') ({{data.player}})
				input(type='text', ng-show='editing', ng-model='data.player')

			div#avatar
				form(enctype='multipart/form-data', ng-show='editing')
					input(name='avatar', type='file', accept='image/*', onchange='uploadAvatar()')
				div#imgContainer
					img(src='avatar', onerror='if(this.src!="/static/img/no-avatar.png")this.src="/static/img/no-avatar.png"')


		#aspects.sheet-panel(ng-controller='AspectCtrl')
			a#aspects
			p.sectionHeader Aspects
				if logged_user == owner
					input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_150_edit.png', ng-click='editing = !editing')

			.field
				p.fieldLabel High Concept:
				p(ng-hide='editing') {{data.aspects.high_concept.name}}
				input(type='text', ng-show='editing', ng-model='data.aspects.high_concept.name')

			.field
				p.fieldLabel Trouble:
				p(ng-hide='editing') {{data.aspects.trouble.name}}
				input(type='text', ng-show='editing', ng-model='data.aspects.trouble.name')

			.field
				p.fieldLabel Other Aspects:
				p(ng-hide='editing', ng-repeat-start='aspect in data.aspects.aspects') {{aspect.name}}
				div(ng-show='editing', ng-repeat-end)
					input(type='text', ng-model='aspect.name')
					input.iconButton(type='image', ng-click='removeAspect($index)',
						style='width: 15px; height: 15px;', src='/static/img/glyphicons/glyphicons_192_circle_remove.png')

			input.iconButton(type='image', ng-show='editing', src='/static/img/glyphicons/glyphicons_190_circle_plus.png', ng-click='addAspect()')


	.sheet-panel-group

		#skills.sheet-panel(ng-controller='SkillCtrl')
			a#skills
			p.sectionHeader Skills
				span(ng-show='data.skills.is_shifter')  (
					input#shifter(type='checkbox', ng-model='shifted')
					label(for='shifter')
					| )
				if logged_user == owner
					input.iconButton(type='image', ng-click='editing=!editing', src='/static/img/glyphicons/glyphicons_150_edit.png')

			p(ng-show='editing')
				| Drag skills to rearrange
				br
				| Drop on +0 to remove

			#skillBlock
				.row(dgy-droppable='editing', dgy-drop='dropHandler', ng-repeat='level in presOrder()', ng-hide='!editing && $last')
					.fieldLabel {{label(level)}}
					.skillList
						.skill.noselect(dgy-draggable='editing', ng-repeat='skill in skills(level)')
							span {{skill}}
							img(ng-show='editing', src='/static/img/glyphicons/glyphicons_186_move.png', style='width: 10px; height: 10px;')
							span(ng-hide='$last') , 

			form(ng-show='editing', ng-submit='addSkill(newSkill); newSkill=""')
				input#newSkill(type='text', ng-model='newSkill')
				input(type='submit', value='Add skill')

			p#validSkillLadder(ng-show='editing') {{valid()}}


		#totals.sheet-panel(ng-controller='TotalsCtrl')
			a#totals
			if logged_user == owner
				input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_150_edit.png', style='left: 330px',
					style='position: absolute; right: 8px;', ng-click='editing=!editing')

			img#star(src='/static/img/pentacle.svg')

			#top-container.container
				#powerLevelContainer
					#powerLevel(ng-hide='editing')
						span Power Level:
						br
						span {{powerLevel()}}
					label(ng-show='editing') Skill Points:
						br
						input(type='number', ng-model='data.totals.skills_total')

				#skillCapContainer
					#skillCap
						span Skill Cap:
						br
						span(ng-hide='editing') {{skillLabel(data.totals.skill_cap)}}
						input(type='number', min=1, max=8, ng-show='editing', ng-model='data.totals.skill_cap')
					label(ng-show='editing')

			#mid-container.container
				#spent-container
					span#skillsSpent.bubble {{skillPointsSpent()}}
					span Skill Points Spent
				#available-container
					span#skillsAvailable.bubble {{skillPointsAvailable()}}
					span Available

			#bottom-container.container
				.row
					span#baseRefresh.bubble.doubleBubble(ng-hide='editing') {{data.totals.base_refresh}}
					input.bubble.doubleBubble(type='number', min=0, ng-show='editing', ng-model='data.totals.base_refresh')
					span Base Refresh Level
				.row
					span#adjustedRefresh.bubble.doubleBubble {{adjustedRefresh()}}
					span Adjusted Refresh
				.row
					span#fatePoints.bubble.doubleBubble(ng-hide='editing') {{data.totals.fate_points}}
					input.bubble.doubleBubble(type='number', min=0, ng-show='editing', ng-model='data.totals.fate_points')
					span Fate Points


	.sheet-panel-group

		#stress.sheet-panel(ng-controller='StressCtrl')
			a#stress
			p.sectionHeader Stress
				if logged_user == owner
					input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_150_edit.png', ng-click='editing=!editing')
			//'stress': [{
				'name': 'Physical','skill': 'Endurance','toughness': 0,'boxes': [{'used': false},{'used':false}],'armor': []},{
				'name': 'Mental','skill': 'Conviction','toughness': 0,'boxes': [{'used': false},{'used':false}],'armor': []},{
				'name': 'Social','skill': 'Presence','toughness': 0,'boxes': [{'used': false},{'used':false}],'armor': []}],


			#stressBlock(ng-hide='editing')
				.track
					.rowHeader
					.boxes
						.colHeader(ng-repeat='i in [1,2,3,4,5,6,7,8]')
							span {{i}}

				.track(ng-repeat-start='track in data.stress', ng-init='trackIndex = $index')
					.rowHeader
						span {{track.name}}
						br
						span.subtitle ({{track.skill}})
					.boxes
						.box(ng-repeat='box in [0,1,2,3,4,5,6,7]')
							input.stressBox(type='checkbox', id='{{track.name}}-{{track.skill}}-{{box}}',
								ng-model='track.boxes[box].used', ng-class='manageParens(trackIndex,box)', ng-disabled='!track.boxes[box]')
							if logged_user == owner
								label(for='{{track.name}}-{{track.skill}}-{{box}}')
							else
								label

				.track(ng-repeat-end, ng-repeat='armor in track.armor') {{armorText(trackIndex,$index)}}

			#stressEditBlock(ng-show='editing')
				// ko foreach: stress
				.track
					.section
						input(type='text', data-bind='value: name')
						input(type='text', data-bind='value: skill')
					.section
						label Strength
						input(type='number', data-bind='value: strength')
					.section
						label Tough
						input(type='number', data-bind='value: toughness')
					.button-section
						input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_270_shield.png',
							data-bind='attr: {onclick: "addArmorTo("+$index()+")"}')
						input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_192_circle_remove.png',
							data-bind='attr: {onclick: "removeStressTrack("+$index()+")"}')

				// ko foreach: armor
				.track
					span Armor:
					input(type='number', data-bind='value: strength')
					span  vs. 
					input(type='text', data-bind='value: vs')
					input.iconButton(type='image', src='/static/img/glyphicons/glyphicons_192_circle_remove.png',
						data-bind='attr: {onclick: "removeArmorFrom("+$parentContext.$index()+","+$index()+")"}')
				// /ko

				// /ko

			input.iconButton(type='image', ng-show='editing', src='/static/img/glyphicons/glyphicons_190_circle_plus.png')


